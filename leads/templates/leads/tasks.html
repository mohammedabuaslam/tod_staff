{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block nav_leads_main %}active open{% endblock %}
{% block nav_tasks %}active{% endblock %}

{% block extra_css %}
<style>
/* Sleek Task Card Styles */
.task-card {
  transition: all 0.3s ease;
  border-radius: 12px;
  border-width: 2px;
}

.task-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.task-card .priority-badge {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.task-card .card-title a:hover {
  color: var(--bs-primary) !important;
}

.task-card .btn-light:hover {
  background-color: var(--bs-gray-200);
  border-color: var(--bs-gray-300);
}

.task-card .dropdown-menu {
  border-radius: 8px;
  border: none;
}

/* Completed Task Styles */
.task-completed {
  opacity: 0.7;
  background-color: #f8f9fa !important;
}

.task-completed .card-title,
.task-completed .task-description {
  color: #6c757d !important;
}

.task-completed .card-title a {
  color: #6c757d !important;
  text-decoration: line-through;
}

.task-completed .badge {
  opacity: 0.6;
}

.task-completed:hover {
  transform: translateY(-2px);
  opacity: 0.8;
}

.task-card .badge {
  font-size: 0.75rem;
  font-weight: 500;
}

.task-card .rounded-pill {
  border-radius: 50px !important;
}

.task-card .task-description p {
  font-size: 0.95rem;
  line-height: 1.4;
}

.task-card .card-footer {
  border-radius: 0 0 12px 12px;
}

/* Status specific styles */
.bg-light-success {
  background-color: rgba(25, 135, 84, 0.05) !important;
}

.bg-light-danger {
  background-color: rgba(220, 53, 69, 0.05) !important;
}

/* Priority indicator animation */
.priority-badge {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .task-card .d-flex.gap-2 {
    flex-direction: column;
  }
  
  .task-card .btn.flex-fill {
    flex: none !important;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ title }}</h5>
        <a href="{% url 'leads:lead_create' %}" class="btn btn-primary">
          <i class="bx bx-plus me-1"></i>Create New Lead
        </a>
      </div>
      <div class="card-body">
        
        <!-- Filter Section -->
        <div class="row mb-4">
          <div class="col-12">
            <form method="GET" class="d-flex flex-wrap gap-3 align-items-end">
              <div style="min-width: 150px;">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                  <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Tasks</option>
                  <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending Only</option>
                  <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed Only</option>
                </select>
              </div>
              <div style="min-width: 150px;">
                <label for="priority" class="form-label">Priority</label>
                <select class="form-select" id="priority" name="priority">
                  <option value="">All Priorities</option>
                  {% for value, label in priority_choices %}
                    <option value="{{ value }}" {% if value == priority_filter %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <button type="submit" class="btn btn-primary">
                  <i class="bx bx-search me-1"></i>Filter
                </button>
              </div>
              <div>
                <a href="{% url 'leads:tasks' %}" class="btn btn-outline-secondary">
                  <i class="bx bx-refresh me-1"></i>Clear
                </a>
              </div>
            </form>
          </div>
        </div>

        {% if task_activities %}
          <div class="row">
            {% for task in task_activities %}
              <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card task-card h-100 position-relative overflow-hidden
                  {% if task.is_completed %}border-secondary bg-light text-muted task-completed
                  {% elif task.is_overdue %}border-danger bg-light-danger
                  {% else %}border-primary{% endif %} shadow-sm">
                  
                  <!-- Priority Indicator -->
                  <div class="position-absolute top-0 end-0 p-2">
                    <div class="priority-badge 
                      {% if task.is_completed %}bg-secondary
                      {% elif task.priority == 'high' %}bg-danger
                      {% elif task.priority == 'medium' %}bg-warning
                      {% else %}bg-info{% endif %} rounded-circle d-flex align-items-center justify-content-center" 
                      style="width: 12px; height: 12px; {% if task.is_completed %}opacity: 0.5;{% endif %}" 
                      title="{{ task.get_priority_display }} Priority{% if task.is_completed %} (Completed){% endif %}">
                    </div>
                  </div>

                  <div class="card-body p-4">
                    <!-- Header Section -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                      <div class="flex-grow-1">
                        <h5 class="card-title mb-1 fw-bold">
                          <a href="{% url 'leads:lead_detail' lead_id=task.lead.lead_id %}" 
                             class="text-decoration-none text-dark hover-primary">
                            {{ task.lead.name|default:"Unknown Lead" }}
                          </a>
                        </h5>
                        <div class="d-flex gap-1 mb-2">
                          <span class="badge bg-light text-dark border">{{ task.lead.get_lead_stage_display }}</span>
                          <span class="badge 
                            {% if task.lead.lead_status == 'new' %}bg-info
                            {% elif task.lead.lead_status == 'contacted' %}bg-warning
                            {% elif task.lead.lead_status == 'qualified' %}bg-primary
                            {% elif task.lead.lead_status == 'closed_won' %}bg-success
                            {% elif task.lead.lead_status == 'closed_lost' %}bg-danger
                            {% else %}bg-secondary{% endif %}">
                            {{ task.lead.get_lead_status_display }}
                          </span>
                        </div>
                      </div>
                      
                      <!-- Action Dropdown -->
                      <div class="dropdown">
                        <button class="btn btn-sm btn-light rounded-circle" type="button" 
                                data-bs-toggle="dropdown" aria-expanded="false" style="width: 32px; height: 32px;">
                          <i class="bx bx-dots-horizontal-rounded"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow">
                          <li>
                            <a class="dropdown-item" href="{% url 'leads:lead_detail' lead_id=task.lead.lead_id %}">
                              <i class="bx bx-show me-2 text-primary"></i>View Lead
                            </a>
                          </li>
                          <li>
                            <a class="dropdown-item" href="#" onclick="toggleTaskComplete({{ task.id }}, {{ task.is_completed|yesno:'true,false' }})">
                              <i class="bx {% if task.is_completed %}bx-x{% else %}bx-check{% endif %} me-2 text-success"></i>
                              {% if task.is_completed %}Mark Pending{% else %}Mark Complete{% endif %}
                            </a>
                          </li>
                          {% if not task.is_completed %}
                          <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#postponeModal{{ task.id }}">
                              <i class="bx bx-time me-2 text-warning"></i>Postpone
                            </a>
                          </li>
                          {% endif %}
                        </ul>
                      </div>
                    </div>

                    <!-- Task Description -->
                    <div class="task-description mb-3">
                      <p class="text-dark mb-0 fw-medium">{{ task.description }}</p>
                    </div>

                    <!-- Due Date & Status -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      {% if task.due_date %}
                        <div class="text-muted small">
                          <i class="bx bx-clock me-1"></i>
                          {{ task.get_ist_due_date|date:"M d, Y" }}
                          <span class="d-block">{{ task.get_ist_due_date|date:"g:i A" }} IST</span>
                        </div>
                      {% else %}
                        <div class="text-muted small">
                          <i class="bx bx-clock me-1"></i>No due date
                        </div>
                      {% endif %}
                      
                      <div class="task-status">
                        {% if task.is_completed %}
                          <span class="badge bg-secondary text-white rounded-pill">
                            <i class="bx bx-check me-1"></i>Completed
                          </span>
                        {% elif task.is_overdue %}
                          <span class="badge bg-danger rounded-pill">
                            <i class="bx bx-time me-1"></i>Overdue
                          </span>
                        {% else %}
                          <span class="badge bg-secondary rounded-pill">
                            <i class="bx bx-time-five me-1"></i>Pending
                          </span>
                        {% endif %}
                      </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-2 flex-wrap">
                      {% if task.lead.number %}
                        <a href="{{ task.lead.get_whatsapp_link }}" target="_blank" 
                           class="btn btn-sm btn-success rounded-pill flex-fill">
                          <i class="bx bxl-whatsapp me-1"></i>{{ task.lead.number }}
                        </a>
                      {% endif %}
                      <button class="btn btn-sm btn-outline-primary rounded-pill" 
                              data-bs-toggle="modal" 
                              data-bs-target="#taskModal{{ task.id }}">
                        <i class="bx bx-note me-1"></i>Notes
                      </button>
                    </div>
                  </div>

                  <!-- Footer -->
                  <div class="card-footer bg-light border-0 py-2 px-4">
                    <div class="d-flex justify-content-between align-items-center">
                      <small class="text-muted">
                        <i class="bx bx-user me-1"></i>{{ task.created_by.get_full_name|default:task.created_by.username }}
                      </small>
                      {% if task.lead.pincode %}
                        <small class="text-muted">
                          <i class="bx bx-map-pin me-1"></i>{{ task.lead.pincode }}
                        </small>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Task Detail Modals -->
          {% for task in task_activities %}
            <div class="modal fade" id="taskModal{{ task.id }}" tabindex="-1" aria-labelledby="taskModalLabel{{ task.id }}" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel{{ task.id }}">Task Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h6>Lead Information</h6>
                        <p><strong>Name:</strong> {{ task.lead.name|default:"Unknown" }}</p>
                        <p><strong>Phone:</strong> {{ task.lead.number|default:"N/A" }}</p>
                        <p><strong>Email:</strong> {{ task.lead.email|default:"N/A" }}</p>
                        <p><strong>Status:</strong> {{ task.lead.get_lead_status_display }}</p>
                        <p><strong>Stage:</strong> {{ task.lead.get_lead_stage_display }}</p>
                      </div>
                      <div class="col-md-6">
                        <h6>Task Information</h6>
                        <p><strong>Description:</strong> {{ task.description }}</p>
                        {% if task.due_date %}
                          <p><strong>Due Date:</strong> {{ task.get_ist_due_date|date:"M d, Y g:i A" }} IST</p>
                        {% endif %}
                        {% if task.priority %}
                          <p><strong>Priority:</strong> {{ task.get_priority_display }}</p>
                        {% endif %}
                        <p><strong>Status:</strong> 
                          {% if task.is_completed %}
                            <span class="badge bg-success">Completed</span>
                          {% else %}
                            <span class="badge bg-secondary">Pending</span>
                          {% endif %}
                        </p>
                        <p><strong>Created by:</strong> {{ task.created_by.get_full_name|default:task.created_by.username }}</p>
                        <p><strong>Created:</strong> {{ task.get_ist_created_date|date:"M d, Y g:i A" }} IST</p>
                      </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Task Notes Section -->
                    <div class="row">
                      <div class="col-12">
                        <h6>Task Notes</h6>
                        <div id="notesContainer{{ task.id }}" class="mb-3">
                          {% for note in task.notes.all %}
                            <div class="card mb-2">
                              <div class="card-body p-3">
                                <p class="mb-1">{{ note.note }}</p>
                                <small class="text-muted">
                                  <i class="bx bx-user me-1"></i>{{ note.created_by.get_full_name|default:note.created_by.username }} - 
                                  {{ note.get_ist_created_date|date:"M d, Y g:i A" }} IST
                                </small>
                              </div>
                            </div>
                          {% empty %}
                            <p class="text-muted">No notes added yet.</p>
                          {% endfor %}
                        </div>
                        
                        <!-- Add Note Form -->
                        <form id="noteForm{{ task.id }}">
                          <div class="mb-3">
                            <label for="note{{ task.id }}" class="form-label">Add Note</label>
                            <textarea class="form-control" id="note{{ task.id }}" name="note" rows="3" required></textarea>
                          </div>
                          <button type="submit" class="btn btn-primary">
                            <i class="bx bx-plus me-1"></i>Add Note
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="{% url 'leads:lead_detail' lead_id=task.lead.lead_id %}" class="btn btn-primary">
                      <i class="bx bx-show me-1"></i>View Lead Details
                    </a>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}

          <!-- Postpone Task Modals -->
          {% for task in task_activities %}
            {% if not task.is_completed %}
              <div class="modal fade" id="postponeModal{{ task.id }}" tabindex="-1" aria-labelledby="postponeModalLabel{{ task.id }}" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="postponeModalLabel{{ task.id }}">Postpone Task</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <p><strong>Task:</strong> {{ task.description }}</p>
                      <p><strong>Lead:</strong> {{ task.lead.name|default:"Unknown" }}</p>
                      {% if task.due_date %}
                        <p><strong>Current Due Date:</strong> {{ task.get_ist_due_date|date:"M d, Y g:i A" }} IST</p>
                      {% else %}
                        <p><strong>Current Due Date:</strong> Not set</p>
                      {% endif %}
                      
                      <form id="postponeForm{{ task.id }}">
                        <div class="mb-3">
                          <label for="newDueDate{{ task.id }}" class="form-label">New Due Date & Time (IST)</label>
                          <input type="datetime-local" class="form-control" id="newDueDate{{ task.id }}" name="new_due_date" required>
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="button" class="btn btn-primary" onclick="postponeTask({{ task.id }})">
                        <i class="bx bx-time me-1"></i>Update Due Date
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}

        {% else %}
          <div class="text-center py-5">
            <div class="text-muted">
              <i class="bx bx-task fs-1 mb-3"></i>
              <h5 class="mb-3">No Tasks Found</h5>
              {% if status_filter == 'completed' %}
                <p class="mb-4">No completed tasks found.</p>
              {% elif status_filter == 'pending' %}
                <p class="mb-4">No pending tasks found.</p>
              {% else %}
                <p class="mb-4">There are currently no tasks.</p>
              {% endif %}
              <a href="{% url 'leads:lead_create' %}" class="btn btn-primary">
                <i class="bx bx-plus me-1"></i>Create New Lead
              </a>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
function toggleTaskComplete(taskId, isCurrentlyCompleted) {
    fetch(`/leads/mark-task-complete/${taskId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Reload to update the UI
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the task.');
    });
}

// Handle note addition
document.addEventListener('DOMContentLoaded', function() {
    {% for task in task_activities %}
        document.getElementById('noteForm{{ task.id }}').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('note', document.getElementById('note{{ task.id }}').value);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            fetch('/leads/add-task-note/{{ task.id }}/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to update the notes
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the note.');
            });
        });
    {% endfor %}
});

// Handle task postponement
function postponeTask(taskId) {
    const newDueDate = document.getElementById(`newDueDate${taskId}`).value;
    if (!newDueDate) {
        alert('Please select a new due date.');
        return;
    }
    
    const formData = new FormData();
    formData.append('new_due_date', newDueDate);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/leads/postpone-task/${taskId}/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(document.getElementById(`postponeModal${taskId}`));
            modal.hide();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while postponing the task.');
    });
}

// Add CSRF token to page for AJAX requests
if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
    const csrfToken = '{{ csrf_token }}';
    const metaTag = document.createElement('meta');
    metaTag.name = 'csrf-token';
    metaTag.content = csrfToken;
    document.head.appendChild(metaTag);
    
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'csrfmiddlewaretoken';
    hiddenInput.value = csrfToken;
    document.body.appendChild(hiddenInput);
}
</script>
{% endblock %}